---
title: "Histórico dos prefeitos eleitos em 2016"
output: 
  html_document:
    fig_height: 7
    theme: paper
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(dplyr)
library(plotly)
library(rgdal)
library(leaflet)
library(stringr)
options(scipen = 999)
```

```{r}
source("load_historico.R")
```

```{r}
prefeitos_ganho_wide <- historico_bens_prefeitos_atuais %>% 
  mutate(ganho = totalBens2016 - totalBens2012) %>% 
  select(cpfCandidato, nomeCandidato, `2012` = totalBens2012, `2016` = totalBens2016, ganho, 
         nomeUrnaCandidato, siglaPartido, descUnidEleitoral) %>% 
  tidyr::gather("ano", "totalBens", 3:4) %>%
  arrange(desc(ganho))
```

```{r}
prefeitos_cargo <- historico_bens_prefeitos_atuais %>% 
  select(cpfCandidato, `2012` = descCargo2012, `2016` = descCargo) %>% 
  mutate(`2012` = if_else(is.na(`2012`), "Nada", `2012`)) %>% 
  mutate(`2016` = if_else(is.na(`2016`), "Nada", `2016`)) %>% 
  tidyr::gather("ano", "cargo", 2:3)
```

```{r}
prefeitos_situacao <- historico_bens_prefeitos_atuais %>% 
  select(cpfCandidato, `2012` = descSituacaoEleito2012, `2016` = descSituacaoEleito) %>% 
  mutate(`2012` = if_else(is.na(`2012`), "Nada", `2012`)) %>% 
  mutate(`2016` = if_else(is.na(`2016`), "Nada", `2016`)) %>% 
  tidyr::gather("ano", "situacaoEleito", 2:3)
```

```{r}
historico_prefeitos_aumento <- prefeitos_ganho_wide %>% 
  left_join(prefeitos_cargo) %>% 
  left_join(prefeitos_situacao)
```
Considerando os prefeitos eleitos em 2016 e que foram candidatos a qualquer cargo (prefeito, vice ou vereador) em 2012.

## Top 10 prefeitos que mais aumentaram seu patrimônio
```{r}
historico_prefeitos_aumento %>% 
  head(20) %>% 
  plot_ly() %>%
    add_trace(x = ~as.factor(ano), y = ~totalBens, color = ~nomeUrnaCandidato,
              type = "scatter", mode = "lines+markers",
              text = ~paste(
              "Prefeito:", nomeCandidato, "<br>",
              "Nome de urna:", nomeUrnaCandidato, "<br>",
              "Total de bens: R$ ", totalBens, "<br>",
              "Diferença (2016 - 2012): ", ganho, "<br>",
              "Cargo: ", cargo, "<br>",
              "Situação: ", situacaoEleito, "<br>",
              "Município:", descUnidEleitoral
              ),
            hoverinfo = "text") %>%
    layout(xaxis = list(title = ""),
                    legend = list(orientation = "h"),
           yaxis = list(title = "Valor declarado (R$)"))
```

## Top10 prefeitos com maior ganho relativo

Para essa visualização 2012 é considerado o ano base. Portanto a linha que descreve o ganho de cada prefeito parte do 0 em 2012 e vai até um valor X em 2016, no qual X é a diferença relativa entre o declarado em 2016 e 2012. Ou seja, em quanto % o patrimônio declarado pelo prefeito aumentou de 2012 para 2016.

Cálculo do ganho relativo: 100 * ((totalBens2016 - totalBens2012) / totalBens2012)

O valor em 2012 é 0 para todos os prefeitos pelo motivo de 2012 ser o ano base para a comparação. Portanto, 2012 não apresenta ganho relativo quando comparado a si mesmo.
```{r}
source("plot_helper.R")
plot_ganho(historico_bens_prefeitos_atuais, prefeitos_cargo, prefeitos_situacao, tipoGanho = "relativo")
```

## Top10 prefeitos com maior ganho absoluto

Para essa visualização 2012 é considerado o ano base. Portanto a linha que descreve o ganho de cada prefeito parte do 0 em 2012 e vai até um valor X em 2016, no qual X é a diferença absoluta entre o declarado em 2016 e 2012. Ou seja, quantos reais a mais o prefeito declarou em 2016 com relação a 2012. 

Cálculo do ganho absoluto: totalBens2016 - totalBens2012

O valor em 2012 é 0 para todos os prefeitos pelo motivo de 2012 ser o ano base para a comparação. Portanto, 2012 não apresenta ganho absoluto quando comparado a si mesmo.
```{r}
plot_ganho(historico_bens_prefeitos_atuais, prefeitos_cargo, prefeitos_situacao, tipoGanho = "absoluto")
```

## Cidades da paraíba e o patrimônio de seus prefeitos

Para os prefeitos eleitos em 2016
```{r}
latlong_original <- read.csv("../data/Municipios_Brasileiros.csv", sep = ";")

colnames(latlong_original) <- c("cd_IBGE", "de_Municipio", "cd_UF", "UF", "de_UF", "lat", "lon")

latlong <- latlong_original %>% 
  filter(UF == " PB") %>% 
  select(de_Municipio, lat, lon) %>% 
  mutate(de_Municipio = toupper(de_Municipio)) %>% 
  mutate(de_Municipio = trimws(de_Municipio)) %>% 
  
  mutate(de_Municipio = if_else(de_Municipio == "SÃO DOMINGOS", "SÃO DOMINGOS DE POMBAL", de_Municipio)) %>% 
  mutate(de_Municipio = if_else(de_Municipio == "QUIXABÁ", "QUIXABA", de_Municipio))

rm(latlong_original)
```

```{r}
historico_bens_prefeitos_atuais %>% 
  left_join(latlong, by = c("descUnidEleitoral" = "de_Municipio")) %>%
  
  mutate(popup = paste("Município: ", str_to_upper(descUnidEleitoral), "<br>",
                       "Prefeito:", nomeUrnaCandidato, "<br>",
                       "Total de bens: ", format(totalBens2016, big.mark=".", decimal.mark = ",", nsmall = 2, scientific = FALSE), "</br>"
                            ),
         label = paste(descUnidEleitoral,
                            ": R$", format(totalBens2016, big.mark=".", decimal.mark = ",", nsmall = 2, scientific = FALSE))) %>% 
    leaflet() %>% 
      addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
      addCircles(
          weight = 1, 
          radius = ~(totalBens2016)/500,
          popup = ~popup,
          label = ~label
      )

```



