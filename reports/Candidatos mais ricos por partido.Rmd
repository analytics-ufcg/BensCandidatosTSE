---
title: "Candidatos mais ricos por partido"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.align = 'center',
  fig.width = 7)

options(scipen = 999)

library(tidyverse)
library(ggplot2)
library(scales)
library(plotly)
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)

theme_set(theme_bw())
```

```{r}
str_to_brl = function(l){
  paste("R$", format(l, big.mark = ".", scientific = FALSE, trim = TRUE, decimal.mark = ","))
} 
```


```{r}
eleicoes <- src_mysql('eleicoes', group='ministerio-publico', password=NULL, username = "shiny")

query <- sql('
             SELECT *
             FROM candidatos_eleicao
             WHERE ano_Eleicao = 2018')

candidatos_2018 <- tbl(eleicoes, query) %>%
  collect()

cod_partido <- tbl(eleicoes, 'cod_partido') %>%
  collect()

candidatos_2018 <- candidatos_2018 %>%
  left_join(cod_partido)

patrimonio_por_partido <- candidatos_2018 %>%
  group_by(sigla_Partido) %>%
  summarise(
    soma_bens = sum(total_bens),
    media_bens = mean(total_bens),
    mediana_bens = median(total_bens),
    sd_bens = sd(total_bens)
  )
```

## Visão Geral

Nesta análise estudamos os dados de patrimônio dos candidatos em 2018. Faremos nosso estudo sob a perspectiva dos partidos políticos

É importante ressaltar que nessa análise consideramos como patrimônio de um partido a soma do patrimônio dos seus candidatos nas eleições de 2018 (valores declarados ao TSE).

Atualmente temos `r candidatos_2018$sigla_Partido %>% unique() %>% length()` partidos políticos quem tem em média `r str_to_brl(mean(patrimonio_por_partido$soma_bens))` e em mediana `r str_to_brl(median(patrimonio_por_partido$soma_bens))`.

O patrimônio de cada partido em 2018 está distribuído da seguinte forma:

```{r}
patrimonio_por_partido %>% 
  ggplot(aes(x = "", y = soma_bens)) +
  geom_boxplot(outlier.shape = NA) +
  geom_text_repel(aes(label=sigla_Partido), position=position_jitter(width=0.4)) +
  labs(x = "Partidos", y = "Patrimônio") +
  scale_y_continuous(breaks=c(0, 1e9, 2e9, 3e9),
                     labels=c("0", "1 bi", "2 bi", "3 bi"))

```

Observamos que a grande maioria dos partidos tem patrimônio de no máximo 2 bilhões de reais, apenas o __Partido Republicano da Ordem Social (PROS)__ está muito acima desse valor com um total de `r str_to_brl((patrimonio_por_partido %>% filter(sigla_Partido == "PROS"))$soma_bens)`.

## Variação dentro do partido

```{r}
candidatos_2018 %>%
  ggplot(aes(x = sigla_Partido, y = total_bens, color = sigla_Partido)) +
  geom_point(show.legend = FALSE, alpha = 0.5) +
  coord_flip() + 
  #theme(axis.text.x = element_text(angle=45, margin = margin(t = 10))) +
  labs(x = "Partido", y = "Patrimônio") +
  scale_y_continuous(breaks=c(0, 1e8, 2.5e8, 5e8, 7.5e8, 1e9),
                     labels=c("0", "100 mi", "250 mi", "500 mi", "750 mi", "1 bi"))
```

Neste caso vemos que `r round((candidatos_2018 %>% filter(total_bens <= 1e8) %>% nrow())/(candidatos_2018 %>% nrow()), 3) * 100`% dos candidatos tem até 100 milhões de patrimônio, apenas `r candidatos_2018 %>% filter(total_bens > 1e8) %>% nrow()` candidatos possuem mais que isso.

Podemos observar ainda a variação de patrimônio entre candidatos do mesmo observando o desvio padrão.
```{r}
patrimonio_por_partido %>%
  ggplot(aes(y = reorder(sigla_Partido, sd_bens), x = sd_bens)) +
  geom_point(aes(color = sd_bens), show.legend = FALSE) +
  scale_color_gradient(low = "blue", high = "red")  +
  scale_x_continuous(breaks=c(0, 1e7, 2e7, 3e7, 4e7, 5e7),
                     labels=c("0", "10 mi", "20 mi", "30 mi", "40 mi", "50 mi")) +
  labs(x = "Desvio padrão", y = "Partido")
```

## Partidos mais ricos

```{r}
patrimonio_por_partido %>%
  ggplot(aes(x = reorder(sigla_Partido, soma_bens), y = soma_bens)) +
  geom_bar(aes(fill = soma_bens), stat = "identity", show.legend = FALSE) + 
  coord_flip() + 
  scale_fill_gradient(low = "blue", high = "red")  +
  labs(x = "Partido", y = "Patrimônio") +
  scale_y_continuous(breaks=c(0, 1e9, 2e9, 3e9),
                     labels=c("0", "1 bi", "2 bi", "3 bi"))
```


## Mais ricos por partido

```{r}
top_por_partido <- candidatos_2018 %>%
  group_by(sigla_Partido) %>%
  top_n(3, wt = total_bens)

top_por_partido %>%
  plot_ly(x = ~total_bens, y=~sigla_Partido, color =~sigla_Partido, mode = 'markers', type= 'scatter',
          text = ~paste(nome_Urna_Candidato, "(", sigla_Partido, ")", 
                        "<br>", str_to_brl(total_bens)),
          hoverinfo = 'text') %>%
  layout(xaxis = list(title = "Patrimônio"),
         yaxis = list(title = "Partido"),
         title = "3 maiores patrimônios por partido",
         showlegend = FALSE,
         margin = list(b = 30, t = 30)) 
  
```

## Não possuem patrimônio

Alguns candidatos não declararam seu patrimônio ou declararam não ter patrimônio, a tabela abaixo mostra um resumo desses casos por partido

```{r}
library(DT)

nao_declararam <- candidatos_2018 %>%
  filter(total_bens == 0) %>%
  group_by(sigla_Partido) %>%
  summarise(n = n()) %>%
  left_join(candidatos_2018 %>%
              group_by(sigla_Partido) %>%
              summarise(total_candidatos = n())) %>%
  mutate(perc = paste( round( (n/total_candidatos) *100, 1), "%"))


nao_declararam <- nao_declararam[order(nao_declararam$perc),]

datatable(nao_declararam, colnames = c("Partido", "# de candidatos que não declararam", "# candidatos total", "Porcentagem"),
          rownames = FALSE)
```

